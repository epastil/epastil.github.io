<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ICU Sankey Explorer</title>
<script src="js/plotly.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
#controls { display: flex; flex-wrap: wrap; gap: 15px; padding-bottom: 15px; }
label { font-weight: bold; margin-right: 5px; }
select { padding: 6px 10px; font-size: 15px; }
button { padding: 6px 12px; font-size: 14px; font-weight: bold; cursor: pointer; }
#sankeyDiv { width: 100%; height: 600px; }
#status { font-size: 13px; color: #555; margin-top: 8px; }

/* Manual legend */
#legend-wrapper {
  margin-top: 20px;
  border-top: 1px solid #ccc;
  padding-top: 12px;
}
.legend-section-title {
  margin: 10px 0 4px;
  font-size: 15px;
  font-weight: bold;
}
.legend-list {
  display: flex;
  flex-wrap: wrap;
  gap: 12px 20px;
}
.legend-item {
  display: flex;
  align-items: center;
  font-size: 14px;
}
.swatch {
  display: inline-block;
  width: 18px;
  height: 18px;
  margin-right: 6px;
  border-radius: 4px;
  border: 1px solid #444;
}
</style>
</head>

<body>

<h2>ARF patients Interactive CCI Explorer </h2>

<div id="controls">

  <!-- SEX (new) -->
  <div>
    <label>Sex:</label>
    <select id="sexSelect">
      <option value="all">All</option>
      <option value="female">Female</option>
      <option value="male">Male</option>
    </select>
  </div>

  <!-- AGE -->
  <div>
    <label>Age group:</label>
    <select id="ageSelect">
      <option value="all">All</option>
      <option value="18_49">18–49</option>
      <option value="50_59">50–59</option>
      <option value="60_69">60–69</option>
      <option value="70_79">70–79</option>
      <option value="80_plus">80+</option>
    </select>
  </div>

  <!-- SURGICAL -->
  <div>
    <label>Surgical status:</label>
    <select id="surgSelect">
      <option value="all">All</option>
      <option value="surgical">Surgical</option>
      <option value="medical">Medical</option>
    </select>
  </div>

  <!-- AGE FACTOR -->
  <div>
    <label>CCI Age factor:</label>
    <select id="isAgeSelect">
      <option value="include_age">Include</option>
      <option value="exclude_age">Exclude</option>
    </select>
  </div>

  <!-- LABEL MODE -->
  <div>
    <label>Label mode:</label>
    <select id="labelModeSelect">
      <option value="label_count">Count</option>
      <option value="label_count_perc">Count & %</option>
    </select>
  </div>

  <button onclick="resetAll()">Reset</button>

</div>

<div id="status"></div>
<div id="sankeyDiv"></div>

<!-- Manual Legend -->
<div id="legend-wrapper">
  <div class="legend-section-title">Legend</div>
  <div class="legend-list">
    <div class="legend-item"><span class="swatch" style="background:rgb(31, 119, 180, 0.5)"></span>CCI: 0</div>
    <div class="legend-item"><span class="swatch" style="background:rgb(255, 127, 14, 0.5)"></span>CCI: 1–2</div>
    <div class="legend-item"><span class="swatch" style="background:rgb(44, 160, 44, 0.5)"></span>CCI: 3–4</div>
    <div class="legend-item"><span class="swatch" style="background:rgb(214, 39, 40, 0.5)"></span>CCI: 5+</div>
    <div class="legend-item"><span class="swatch" style="background:rgb(148, 103, 189, 0.5)"></span>Death</div>
  </div>
</div>

<script>
// ------------------- State -------------------
var state = {
  surg: "all",
  sex: "all",      // <--- NEW
  age: "all",
  isage: "include_age",
  islabel: "label_count"
};

// ------------------- URL & State -------------------
function saveState() {
  localStorage.setItem("icuSankeyState", JSON.stringify(state));
}

function loadSavedState() {
  const saved = localStorage.getItem("icuSankeyState");
  return saved ? JSON.parse(saved) : null;
}

function applyStateToUI() {
  document.getElementById("surgSelect").value = state.surg;
  document.getElementById("sexSelect").value = state.sex;
  document.getElementById("ageSelect").value = state.age;
  document.getElementById("isAgeSelect").value = state.isage;
  document.getElementById("labelModeSelect").value = state.islabel;
}

function getURLParams() {
  const p = new URLSearchParams(window.location.search);
  return {
    surg: p.get("surg"),
    sex: p.get("sex"),
    age: p.get("age"),
    isage: p.get("isage"),
    islabel: p.get("label")
  };
}

function updateURL() {
  const p = new URLSearchParams();
  p.set("surg", state.surg);
  p.set("sex", state.sex);
  p.set("age", state.age);
  p.set("isage", state.isage);
  p.set("label", state.islabel);
  history.replaceState(null, "", "?" + p.toString());
}

// ------------------- Load dataset -------------------
async function loadDataset(key) {
  const url = "datasets/" + key + ".json";
  const resp = await fetch(url);
  return resp.ok ? resp.json() : null;
}

// ------------------- HEADER ANNOTATIONS -------------------
function buildHeaderAnnotations(locMap) {
  return Object.values(locMap).map(cfg => ({
    x: cfg.x,
    y: 1.1,
    xref: "paper",
    yref: "paper",
    text: cfg.text,
    showarrow: true,
    ax: 0,
    ay: 0,
    font: { size: 14 , variant:"all-petite-caps"},
    align: "center",
  }));
}

// ------------------- PLOT -------------------
async function updateSankey() {
  const key =
    state.surg + "__" +
    state.sex + "__" +     // ← NEW
    state.age + "__" +
    state.isage + "__" +
    state.islabel;

  document.getElementById("status").textContent = "Loading " + key + "...";

  const data = await loadDataset(key);
  if (!data || !data.node|| !data.link || !data.loc_map) {
    document.getElementById("status").textContent = "Dataset missing: " + key;
    return;
  }

  const trace = {
    type: "sankey",
    orientation: "h",
    node: data.node,
    link: data.link,
    valueformat: ".0f",
    arrangement: "snap"
  };

  const layout = {
    font: { size: 13 },
    // margin: { l: 10, r: 10, t: 80, b: 10 },
    annotations: buildHeaderAnnotations(data.loc_map)
  };

  Plotly.react("sankeyDiv", [trace], layout);

  document.getElementById("status").textContent = "Showing: " + key;
  document.getElementById("status").textContent = "" ;

  saveState();
  updateURL();
}

// ------------------- Reset -------------------
function resetAll() {
  state = { surg: "all", sex: "all", age: "all", isage: "include_age", islabel: "label_count" };
  localStorage.removeItem("icuSankeyState");
  history.replaceState(null, "", window.location.pathname);
  applyStateToUI();
  updateSankey();
}

// ------------------- UI HANDLERS -------------------
document.getElementById("surgSelect").addEventListener("change", e => { state.surg = e.target.value; updateSankey(); });
document.getElementById("sexSelect").addEventListener("change", e => { state.sex = e.target.value; updateSankey(); });
document.getElementById("ageSelect").addEventListener("change", e => { state.age = e.target.value; updateSankey(); });
document.getElementById("isAgeSelect").addEventListener("change", e => { state.isage = e.target.value; updateSankey(); });
document.getElementById("labelModeSelect").addEventListener("change", e => { state.islabel = e.target.value; updateSankey(); });

// ------------------- INIT -------------------
document.addEventListener("DOMContentLoaded", async () => {
  const url = getURLParams();
  const saved = loadSavedState();

  if (url.surg && url.sex && url.age && url.isage && url.islabel) {
    Object.assign(state, url);
  } else if (saved) {
    Object.assign(state, saved);
  }

  applyStateToUI();
  updateSankey();
});
</script>

</body>
</html>
