<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ICU Sankey Explorer</title>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
#controls { display: flex; flex-wrap: wrap; gap: 15px; padding-bottom: 15px; }
label { font-weight: bold; margin-right: 5px; }
select { padding: 6px 10px; font-size: 15px; }
button { padding: 6px 12px; font-size: 14px; font-weight: bold; cursor: pointer; }
#sankeyDiv { width: 100%; height: 700px; }
#status { font-size: 13px; color: #555; margin-top: 8px; }
</style>
</head>

<body>

<h2>ICU Sankey Interactive Explorer</h2>

<div id="controls">

  <div>
    <label>Surgical status:</label>
    <select id="surgSelect">
      <option value="all">All</option>
      <option value="surgical">Surgical</option>
      <option value="medical">Medical</option>
    </select>
  </div>

  <div>
    <label>Age group:</label>
    <select id="ageSelect">
      <option value="all">All</option>
      <option value="18_49">18–49</option>
      <option value="50_59">50–59</option>
      <option value="60_69">60–69</option>
      <option value="70_79">70–79</option>
      <option value="80_plus">80+</option>
    </select>
  </div>

  <div>
    <label>CCI calculation:</label>
    <select id="isAgeSelect">
      <option value="include_age">Include age</option>
      <option value="exclude_age">Exclude age</option>
    </select>
  </div>

  <div>
    <label>Label mode:</label>
    <select id="labelModeSelect">
      <option value="label_count">Counts</option>
      <option value="label_count_perc">Counts + %</option>
    </select>
  </div>

  <button onclick="resetAll()">Reset</button>

</div>

<div id="status"></div>
<div id="sankeyDiv"></div>

<script>
// ------------------- State & Persistence -------------------
var state = {
  surg: "all",
  age: "all",
  isage: "include_age",
  islabel: "label_count"
};

 function buildHeaderAnnotations(locMap) {
        return Object.values(locMap).map(cfg => ({
            x: cfg.x,
            y: 1.1,          // slightly above the top
            xref: "paper",
            yref: "paper",
            text: cfg.text,
            showarrow: true,
            ax: 0,
            ay: 0,
            font: {
                size: 16,
                color: "black"
            },
            align: "center",
            valign: "middle",
            height:40
        }));
    }

function saveState() {
  localStorage.setItem("icuSankeyState", JSON.stringify(state));
}

function loadSavedState() {
  const saved = localStorage.getItem("icuSankeyState");
  return saved ? JSON.parse(saved) : null;
}

function applyStateToUI() {
  document.getElementById("surgSelect").value = state.surg;
  document.getElementById("ageSelect").value = state.age;
  document.getElementById("isAgeSelect").value = state.isage;
  document.getElementById("labelModeSelect").value = state.islabel;
}

// ------------------- URL Query Support -------------------
function getURLParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    surg: params.get("surg"),
    age: params.get("age"),
    isage: params.get("isage"),
    islabel: params.get("label")
  };
}

function updateURL() {
  const params = new URLSearchParams();
  params.set("surg", state.surg);
  params.set("age", state.age);
  params.set("isage", state.isage);
  params.set("label", state.islabel);
  history.replaceState(null, "", "?" + params.toString());
}

// ------------------- Load Dataset -------------------
async function loadDataset(key) {
  const url = "datasets/" + key + ".json";
  const resp = await fetch(url);
  if (!resp.ok) {
    console.warn("Dataset not found:", url);
    return null;
  }
  return await resp.json();
}

// ------------------- Draw Sankey -------------------
async function updateSankey() {
  const key = state.surg + "__" + state.age + "__" + state.isage + "__" + state.islabel;
  document.getElementById("status").textContent = "Loading " + key + "...";

  const data = await loadDataset(key);

  if (!data || !data.node || !data.link) {
    document.getElementById("status").textContent = "No data for " + key;
    return;
  }
  loc_map = data.loc_map

  const trace = {
    type: "sankey",
    orientation: "h",
    valueformat: ".0f",
    valuesuffix: " patients",
    arrangement: "snap",
    node: data.node,
    link: data.link
  };

  const layout = {
    font: { size: 13 },
    // margin: { l: 10, r: 10, t: 80, b: 10 }
                  annotations: buildHeaderAnnotations(loc_map)

  };


  Plotly.react("sankeyDiv", [trace], layout);
  document.getElementById("status").textContent = "Showing: " + key;
  document.getElementById("status").textContent = "" ;

  saveState();
  updateURL();
}

// ------------------- Reset -------------------
function resetAll() {
  state = { surg: "all", age: "all", isage: "include_age", islabel: "label_count" };
  localStorage.removeItem("icuSankeyState");
  history.replaceState(null, "", window.location.pathname);
  applyStateToUI();
  updateSankey();
}

// ------------------- UI Handlers -------------------
document.getElementById("surgSelect").addEventListener("change", e => { state.surg = e.target.value; updateSankey(); });
document.getElementById("ageSelect").addEventListener("change", e => { state.age = e.target.value; updateSankey(); });
document.getElementById("isAgeSelect").addEventListener("change", e => { state.isage = e.target.value; updateSankey(); });
document.getElementById("labelModeSelect").addEventListener("change", e => { state.islabel = e.target.value; updateSankey(); });

// ------------------- Initialize -------------------
document.addEventListener("DOMContentLoaded", async () => {
  const urlParams = getURLParams();
  const saved = loadSavedState();

  if (urlParams.surg && urlParams.age && urlParams.isage && urlParams.islabel) {
    Object.assign(state, urlParams);
  } else if (saved) {
    Object.assign(state, saved);
  }

  applyStateToUI();
  await updateSankey();
});
</script>

</body>
</html>
